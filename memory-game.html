<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>记忆翻牌</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
</head>
<body>

  <div class="page-wrapper">

    <!-- Top Bar -->
    <div class="top-bar">
      <button class="back-btn" id="backBtn">&#9664; 返回大厅</button>
      <h1>记忆翻牌</h1>
      <span></span>
    </div>

    <!-- Level Select -->
    <div id="levelSelect">
      <div class="level-grid" id="levelGrid"></div>
    </div>

    <!-- Game Area -->
    <div class="game-area" id="gameArea">
      <div class="info-bar">
        <span id="levelLabel">关卡 1</span>
        <span>翻牌: <b id="moveCount">0</b> / 推荐 <b id="parCount">0</b></span>
      </div>
      <div class="memory-board" id="memoryBoard"></div>
      <div class="btn-row">
        <button class="btn btn-reset" id="resetBtn">重置</button>
        <button class="btn btn-primary" id="levelListBtn">选关</button>
      </div>
    </div>

  </div>

  <!-- Win Overlay -->
  <div class="overlay" id="winOverlay">
    <div class="win-card">
      <h2>恭喜过关！</h2>
      <div class="win-stars" id="winStars"></div>
      <p id="winMsg"></p>
      <div>
        <button class="btn btn-reset" id="winBackBtn">选关</button>
        <button class="btn btn-primary" id="winNextBtn">下一关</button>
      </div>
    </div>
  </div>

  <script>
    /* =====================================================
       LEVELS DATA
       pairs: number of pairs, cols/rows for grid, par (recommended flips)
       ===================================================== */
    var LEVELS = [
      { pairs: 2,  cols: 2, rows: 2, par: 4 },
      { pairs: 3,  cols: 3, rows: 2, par: 8 },
      { pairs: 4,  cols: 4, rows: 2, par: 12 },
      { pairs: 6,  cols: 4, rows: 3, par: 16 },
      { pairs: 8,  cols: 4, rows: 4, par: 22 },
      { pairs: 10, cols: 5, rows: 4, par: 28 },
      { pairs: 12, cols: 6, rows: 4, par: 34 },
      { pairs: 15, cols: 6, rows: 5, par: 42 },
      { pairs: 18, cols: 6, rows: 6, par: 50 }
    ];

    /* Word-Emoji pairs pool for cards (English word ↔ emoji image) */
    var WORDS = [
      { word: 'cat', emoji: '\ud83d\udc31' },
      { word: 'dog', emoji: '\ud83d\udc36' },
      { word: 'fish', emoji: '\ud83d\udc1f' },
      { word: 'bird', emoji: '\ud83d\udc26' },
      { word: 'apple', emoji: '\ud83c\udf4e' },
      { word: 'book', emoji: '\ud83d\udcd6' },
      { word: 'star', emoji: '\u2b50' },
      { word: 'sun', emoji: '\u2600\ufe0f' },
      { word: 'moon', emoji: '\ud83c\udf19' },
      { word: 'tree', emoji: '\ud83c\udf33' },
      { word: 'flower', emoji: '\ud83c\udf38' },
      { word: 'house', emoji: '\ud83c\udfe0' },
      { word: 'car', emoji: '\ud83d\ude97' },
      { word: 'ball', emoji: '\u26bd' },
      { word: 'hat', emoji: '\ud83c\udfa9' },
      { word: 'cake', emoji: '\ud83c\udf70' },
      { word: 'rain', emoji: '\ud83c\udf27\ufe0f' },
      { word: 'snow', emoji: '\u2744\ufe0f' }
    ];

    /* =====================================================
       SEEDED RNG (mulberry32)
       ===================================================== */
    function seededRng(seed) {
      return function() {
        seed |= 0;
        seed = seed + 0x6D2B79F5 | 0;
        var t = Math.imul(seed ^ seed >>> 15, 1 | seed);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    function seededShuffle(arr, seed) {
      var rng = seededRng(seed);
      var a = arr.slice();
      for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(rng() * (i + 1));
        var tmp = a[i];
        a[i] = a[j];
        a[j] = tmp;
      }
      return a;
    }

    /* =====================================================
       STATE
       ===================================================== */
    var currentLevel = -1;
    var cards = [];       // array of { pairId, type: 'word'|'emoji', content }
    var flipped = [];     // indices currently flipped
    var matched = [];     // indices already matched
    var moves = 0;        // flip count (each pair of flips = 1)
    var flipCount = 0;    // 0 or 1 flips in current turn
    var locked = false;   // prevent clicks during animation
    var won = false;

    /* =====================================================
       STORAGE HELPERS
       ===================================================== */
    function loadProgress() {
      try {
        var data = localStorage.getItem('memory_progress');
        if (data) return JSON.parse(data);
      } catch (e) {}
      return { unlocked: 1, stars: {} };
    }

    function saveProgress(prog) {
      try {
        localStorage.setItem('memory_progress', JSON.stringify(prog));
      } catch (e) {}
    }

    /* =====================================================
       LEVEL SELECT RENDERING
       ===================================================== */
    function renderLevelSelect() {
      var prog = loadProgress();
      var grid = document.getElementById('levelGrid');
      grid.innerHTML = '';
      for (var i = 0; i < LEVELS.length; i++) {
        var btn = document.createElement('button');
        var unlocked = (i + 1) <= prog.unlocked;
        btn.className = 'level-btn ' + (unlocked ? 'unlocked' : 'locked');
        var label = '' + (i + 1);
        var starStr = '';
        if (unlocked && prog.stars[i + 1]) {
          var s = prog.stars[i + 1];
          for (var j = 0; j < 3; j++) {
            starStr += j < s ? '\u2605' : '\u2606';
          }
        }
        btn.innerHTML = label + (starStr ? '<span class="level-stars">' + starStr + '</span>' : '');
        if (unlocked) {
          btn.setAttribute('data-level', i);
          btn.addEventListener('touchend', onLevelTap, { passive: true });
          btn.addEventListener('click', onLevelTap);
        }
        grid.appendChild(btn);
      }
    }

    function onLevelTap(e) {
      e.preventDefault();
      var idx = parseInt(this.getAttribute('data-level'), 10);
      startLevel(idx);
    }

    /* =====================================================
       START LEVEL
       ===================================================== */
    function startLevel(idx) {
      currentLevel = idx;
      var lvl = LEVELS[idx];
      moves = 0;
      flipCount = 0;
      flipped = [];
      matched = [];
      locked = false;
      won = false;

      // Generate card layout with seeded shuffle
      var wordPairs = WORDS.slice(0, lvl.pairs);
      var deck = [];
      for (var i = 0; i < wordPairs.length; i++) {
        deck.push({ pairId: i, type: 'word', content: wordPairs[i].word });
        deck.push({ pairId: i, type: 'emoji', content: wordPairs[i].emoji });
      }
      cards = seededShuffle(deck, (idx + 1) * 7919);

      document.getElementById('levelSelect').style.display = 'none';
      var gameArea = document.getElementById('gameArea');
      gameArea.className = 'game-area active';

      document.getElementById('levelLabel').textContent = '\u5173\u5361 ' + (idx + 1);
      document.getElementById('moveCount').textContent = '0';
      document.getElementById('parCount').textContent = '' + lvl.par;

      renderBoard();
    }

    /* =====================================================
       RENDER BOARD
       ===================================================== */
    function renderBoard() {
      var lvl = LEVELS[currentLevel];
      var board = document.getElementById('memoryBoard');
      board.innerHTML = '';

      board.style.gridTemplateColumns = 'repeat(' + lvl.cols + ', 1fr)';

      for (var i = 0; i < cards.length; i++) {
        var card = document.createElement('div');
        card.className = 'memory-card';
        if (matched.indexOf(i) !== -1) {
          card.className += ' flipped matched';
        }
        card.setAttribute('data-index', i);

        var inner = document.createElement('div');
        inner.className = 'card-inner';

        var front = document.createElement('div');
        front.className = 'card-front';
        front.textContent = '?';

        var back = document.createElement('div');
        back.className = 'card-back ' + (cards[i].type === 'word' ? 'card-back-word' : 'card-back-emoji');
        back.textContent = cards[i].content;

        inner.appendChild(front);
        inner.appendChild(back);
        card.appendChild(inner);

        card.addEventListener('click', onCardTap);
        card.addEventListener('touchend', onCardTap, { passive: false });

        board.appendChild(card);
      }
    }

    /* =====================================================
       CARD TAP
       ===================================================== */
    function onCardTap(e) {
      e.preventDefault();
      if (locked || won) return;

      var cardEl = this;
      var idx = parseInt(cardEl.getAttribute('data-index'), 10);

      // Already flipped or matched
      if (flipped.indexOf(idx) !== -1 || matched.indexOf(idx) !== -1) return;

      // Flip card
      cardEl.classList.add('flipped');
      flipped.push(idx);

      if (flipped.length === 2) {
        moves++;
        document.getElementById('moveCount').textContent = '' + moves;

        var idx1 = flipped[0];
        var idx2 = flipped[1];

        if (cards[idx1].pairId === cards[idx2].pairId) {
          // Match!
          matched.push(idx1);
          matched.push(idx2);
          flipped = [];

          // Mark as matched visually
          var allCards = document.getElementById('memoryBoard').children;
          allCards[idx1].classList.add('matched');
          allCards[idx2].classList.add('matched');

          // Check win
          if (matched.length === cards.length) {
            won = true;
            setTimeout(showWin, 500);
          }
        } else {
          // No match — flip back after delay
          locked = true;
          setTimeout(function() {
            var allCards = document.getElementById('memoryBoard').children;
            allCards[idx1].classList.remove('flipped');
            allCards[idx2].classList.remove('flipped');
            flipped = [];
            locked = false;
          }, 800);
        }
      }
    }

    /* =====================================================
       SHOW WIN
       ===================================================== */
    function showWin() {
      var lvl = LEVELS[currentLevel];
      var stars = 1;
      if (moves <= lvl.par) stars = 3;
      else if (moves <= Math.floor(lvl.par * 1.5)) stars = 2;

      // Save progress
      var prog = loadProgress();
      var prev = prog.stars[currentLevel + 1] || 0;
      if (stars > prev) prog.stars[currentLevel + 1] = stars;
      if (currentLevel + 2 > prog.unlocked) {
        prog.unlocked = currentLevel + 2;
      }
      saveProgress(prog);

      // Show overlay
      var starStr = '';
      for (var i = 0; i < 3; i++) {
        starStr += i < stars ? '\u2b50' : '\u2606';
      }
      document.getElementById('winStars').textContent = starStr;
      document.getElementById('winMsg').textContent = '\u7528\u4e86 ' + moves + ' \u6b21\u7ffb\u724c\uff08\u63a8\u8350 ' + lvl.par + ' \u6b21\uff09';

      var nextBtn = document.getElementById('winNextBtn');
      if (currentLevel + 1 >= LEVELS.length) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = '';
      }

      document.getElementById('winOverlay').className = 'overlay show';
    }

    /* =====================================================
       BUTTONS
       ===================================================== */
    document.getElementById('backBtn').addEventListener('click', function() {
      window.location.href = 'index.html';
    });

    document.getElementById('resetBtn').addEventListener('click', function() {
      if (currentLevel >= 0) startLevel(currentLevel);
    });

    document.getElementById('levelListBtn').addEventListener('click', function() {
      showLevelSelect();
    });

    document.getElementById('winBackBtn').addEventListener('click', function() {
      document.getElementById('winOverlay').className = 'overlay';
      showLevelSelect();
    });

    document.getElementById('winNextBtn').addEventListener('click', function() {
      document.getElementById('winOverlay').className = 'overlay';
      if (currentLevel + 1 < LEVELS.length) {
        startLevel(currentLevel + 1);
      }
    });

    function showLevelSelect() {
      document.getElementById('gameArea').className = 'game-area';
      document.getElementById('levelSelect').style.display = '';
      renderLevelSelect();
    }

    /* =====================================================
       INIT
       ===================================================== */
    var initProg = loadProgress();
    if (initProg.unlocked < 1) {
      initProg.unlocked = 1;
      saveProgress(initProg);
    }
    renderLevelSelect();

    // Register SW
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(function() {});
    }
  </script>
</body>
</html>
