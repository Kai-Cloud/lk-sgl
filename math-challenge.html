<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>速算挑战</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
</head>
<body>

  <div class="page-wrapper">

    <!-- Top Bar -->
    <div class="top-bar">
      <button class="back-btn" id="backBtn">&#9664; 返回大厅</button>
      <h1>速算挑战</h1>
      <span></span>
    </div>

    <!-- Level Select -->
    <div id="levelSelect">
      <div class="level-grid" id="levelGrid"></div>
    </div>

    <!-- Game Area -->
    <div class="game-area" id="gameArea">
      <div class="info-bar">
        <span id="levelLabel">关卡 1</span>
        <span>第 <b id="questionNum">1</b>/<b id="questionTotal">5</b> 题</span>
      </div>

      <!-- Timer bar -->
      <div class="timer-bar-wrap">
        <div class="timer-bar" id="timerBar"></div>
      </div>
      <div class="timer-text" id="timerText">60s</div>

      <!-- Question display -->
      <div class="math-question" id="mathQuestion">1 + 1 = ?</div>

      <!-- Answer display -->
      <div class="math-answer" id="mathAnswer">&nbsp;</div>

      <!-- Feedback -->
      <div class="math-feedback" id="mathFeedback">&nbsp;</div>

      <!-- Number pad -->
      <div class="numpad" id="numpad">
        <button class="numpad-btn" data-val="1">1</button>
        <button class="numpad-btn" data-val="2">2</button>
        <button class="numpad-btn" data-val="3">3</button>
        <button class="numpad-btn" data-val="4">4</button>
        <button class="numpad-btn" data-val="5">5</button>
        <button class="numpad-btn" data-val="6">6</button>
        <button class="numpad-btn" data-val="7">7</button>
        <button class="numpad-btn" data-val="8">8</button>
        <button class="numpad-btn" data-val="9">9</button>
        <button class="numpad-btn numpad-del" data-val="del">&#9003;</button>
        <button class="numpad-btn" data-val="0">0</button>
        <button class="numpad-btn numpad-ok" data-val="ok">OK</button>
      </div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="btn btn-reset" id="resetBtn">重置</button>
        <button class="btn btn-primary" id="levelListBtn">选关</button>
      </div>
    </div>

  </div>

  <!-- Win Overlay -->
  <div class="overlay" id="winOverlay">
    <div class="win-card">
      <h2 id="winTitle">恭喜过关！</h2>
      <div class="win-stars" id="winStars"></div>
      <p id="winMsg"></p>
      <div>
        <button class="btn btn-reset" id="winBackBtn">选关</button>
        <button class="btn btn-primary" id="winNextBtn">下一关</button>
      </div>
    </div>
  </div>

  <script>
    /* =====================================================
       STORAGE ADAPTER FOR LK-SCL INTEGRATION
       Dual-mode storage: localStorage (standalone) vs postMessage (integrated)
       ===================================================== */
    var GameStorage = {
      isInIframe: window.parent !== window,
      gameName: 'math_challenge',

      loadProgress: function() {
        if (this.isInIframe) {
          // Integrated mode: request from parent
          window.parent.postMessage({
            type: 'requestGameProgress',
            game: this.gameName
          }, '*');
          return window.__gameProgress || { unlocked: 1, stars: {} };
        } else {
          // Standalone mode: use localStorage (original behavior)
          try {
            var data = localStorage.getItem('math_progress');
            if (data) return JSON.parse(data);
          } catch (e) {}
          return { unlocked: 1, stars: {} };
        }
      },

      saveProgress: function(level, stars, moves, timeSeconds) {
        if (this.isInIframe) {
          // Integrated mode: send to parent for server sync
          window.parent.postMessage({
            type: 'saveGameProgress',
            game: this.gameName,
            level: level,
            stars: stars,
            moves: moves || 0,
            timeSeconds: timeSeconds || 0
          }, '*');
        } else {
          // Standalone mode: use localStorage
          try {
            var progress = this.loadProgress();
            progress.stars[level] = stars;
            if (level >= progress.unlocked) {
              progress.unlocked = level + 1;
            }
            localStorage.setItem('math_progress', JSON.stringify(progress));
          } catch (e) {}
        }
      }
    };

    // Listen for progress data from parent (integrated mode only)
    if (GameStorage.isInIframe) {
      var lastProgressJson = null;
      window.addEventListener('message', function(event) {
        if (event.data.type === 'loadProgress') {
          var newProgressJson = JSON.stringify(event.data.progress);

          // Only update and re-render if progress actually changed
          if (newProgressJson !== lastProgressJson) {
            window.__gameProgress = event.data.progress;
            lastProgressJson = newProgressJson;

            if (typeof renderLevelSelect === 'function') {
              renderLevelSelect();
            }
          }
        }
      });

      // Notify parent that game is ready
      window.parent.postMessage({
        type: 'gameReady',
        game: GameStorage.gameName
      }, '*');
    }

    /* =====================================================
       LEVELS DATA
       ===================================================== */
    var LEVELS = [
      { total: 5,  ops: ['+'],           min: 10, max: 100, time: 60 },           // L1: 两位数加法
      { total: 8,  ops: ['-'],           min: 10, max: 100, time: 60 },           // L2: 两位数减法
      { total: 8,  ops: ['+','-'],       min: 10, max: 500, time: 60 },           // L3: 三位数加减
      { total: 10, ops: ['*'],           min: 2,  max: 12,  time: 60, mulMode: 'table' },  // L4: 乘法表 2-12×2-12
      { total: 10, ops: ['*'],           min: 10, max: 99,  time: 60, mulMode: '2x1' },    // L5: 两位数×一位数
      { total: 10, ops: ['/'],           min: 2,  max: 50,  time: 60 },           // L6: 整除
      { total: 12, ops: ['+','-','*'],   min: 10, max: 200, time: 50 },           // L7: 加减乘混合
      { total: 12, ops: ['+','-','*','/'], min: 10, max: 500, time: 50 },         // L8: 四则混合
      { total: 15, ops: ['+','-','*','/'], min: 10, max: 999, time: 45 }          // L9: 终极挑战
    ];

    /* =====================================================
       SEEDED RNG (mulberry32)
       ===================================================== */
    function seededRng(seed) {
      return function() {
        seed |= 0;
        seed = seed + 0x6D2B79F5 | 0;
        var t = Math.imul(seed ^ seed >>> 15, 1 | seed);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    /* =====================================================
       QUESTION GENERATION
       ===================================================== */
    function generateQuestions(levelIdx) {
      var lvl = LEVELS[levelIdx];
      var rng = seededRng((levelIdx + 1) * 13337);
      var questions = [];

      for (var i = 0; i < lvl.total; i++) {
        var q = generateOneQuestion(rng, lvl.ops, lvl.min, lvl.max, lvl);
        questions.push(q);
      }
      return questions;
    }

    function generateOneQuestion(rng, ops, min, max, lvl) {
      // Try up to 100 times to get a valid question
      for (var attempt = 0; attempt < 100; attempt++) {
        var op = ops[Math.floor(rng() * ops.length)];
        var a, b, answer;

        if (op === '+') {
          a = Math.floor(rng() * (max - min + 1)) + min;
          b = Math.floor(rng() * (max - min + 1)) + min;
          answer = a + b;
        } else if (op === '-') {
          a = Math.floor(rng() * (max - min + 1)) + min;
          b = Math.floor(rng() * (max - min + 1)) + min;
          if (a < b) { var tmp = a; a = b; b = tmp; }
          answer = a - b;
        } else if (op === '*') {
          if (lvl && lvl.mulMode === 'table') {
            // 乘法表: 2-12 × 2-12
            a = Math.floor(rng() * 11) + 2;
            b = Math.floor(rng() * 11) + 2;
          } else if (lvl && lvl.mulMode === '2x1') {
            // 两位数 × 一位数
            a = Math.floor(rng() * 90) + 10;
            b = Math.floor(rng() * 8) + 2;
          } else {
            // 高级关卡混合乘法: 较小因数
            a = Math.floor(rng() * (Math.min(max, 50) - min + 1)) + min;
            b = Math.floor(rng() * 8) + 2;
          }
          answer = a * b;
        } else if (op === '/') {
          // 整除: answer = rng(2-50), divisor = rng(2-12), dividend = answer * divisor
          var quotient = Math.floor(rng() * 49) + 2;
          b = Math.floor(rng() * 11) + 2;
          a = quotient * b;
          answer = quotient;
        }

        var symbol = op === '*' ? '\u00d7' : op === '/' ? '\u00f7' : op;
        return { text: a + ' ' + symbol + ' ' + b + ' = ?', answer: answer };
      }

      // Fallback: simple addition
      return { text: '1 + 1 = ?', answer: 2 };
    }

    /* =====================================================
       STATE
       ===================================================== */
    var currentLevel = -1;
    var questions = [];
    var currentQ = 0;
    var correctCount = 0;
    var userInput = '';
    var timerInterval = null;
    var timeLeft = 0;
    var gameOver = false;

    /* =====================================================
       STORAGE HELPERS
       ===================================================== */
    function loadProgress() {
      return GameStorage.loadProgress();
    }

    function saveProgress(prog) {
      var level = currentLevel + 1;
      var stars = prog.stars[level];
      var timeElapsed = LEVELS[currentLevel].time - timeRemaining;
      GameStorage.saveProgress(level, stars, 0, timeElapsed);
    }

    /* =====================================================
       LEVEL SELECT RENDERING
       ===================================================== */
    function renderLevelSelect() {
      var prog = loadProgress();
      var grid = document.getElementById('levelGrid');
      grid.innerHTML = '';
      for (var i = 0; i < LEVELS.length; i++) {
        var btn = document.createElement('button');
        var unlocked = (i + 1) <= prog.unlocked;
        btn.className = 'level-btn ' + (unlocked ? 'unlocked' : 'locked');
        var label = '' + (i + 1);
        var starStr = '';
        if (unlocked && prog.stars[i + 1]) {
          var s = prog.stars[i + 1];
          for (var j = 0; j < 3; j++) {
            starStr += j < s ? '\u2605' : '\u2606';
          }
        }
        btn.innerHTML = label + (starStr ? '<span class="level-stars">' + starStr + '</span>' : '');
        if (unlocked) {
          btn.setAttribute('data-level', i);
          btn.addEventListener('click', onLevelTap);
          btn.addEventListener('touchend', onLevelTap, { passive: false });
        }
        grid.appendChild(btn);
      }
    }

    function onLevelTap(e) {
      e.preventDefault();
      var idx = parseInt(this.getAttribute('data-level'), 10);
      startLevel(idx);
    }

    /* =====================================================
       START LEVEL
       ===================================================== */
    function startLevel(idx) {
      currentLevel = idx;
      var lvl = LEVELS[idx];
      questions = generateQuestions(idx);
      currentQ = 0;
      correctCount = 0;
      userInput = '';
      gameOver = false;

      if (timerInterval) clearInterval(timerInterval);
      timeLeft = lvl.time;

      document.getElementById('levelSelect').style.display = 'none';
      var gameArea = document.getElementById('gameArea');
      gameArea.className = 'game-area active';

      document.getElementById('levelLabel').textContent = '\u5173\u5361 ' + (idx + 1);
      document.getElementById('questionTotal').textContent = '' + lvl.total;

      showQuestion();
      startTimer();
    }

    /* =====================================================
       SHOW QUESTION
       ===================================================== */
    function showQuestion() {
      if (currentQ >= questions.length) {
        endGame();
        return;
      }
      document.getElementById('questionNum').textContent = '' + (currentQ + 1);
      document.getElementById('mathQuestion').textContent = questions[currentQ].text;
      document.getElementById('mathAnswer').innerHTML = '&nbsp;';
      document.getElementById('mathFeedback').innerHTML = '&nbsp;';
      document.getElementById('mathFeedback').className = 'math-feedback';
      userInput = '';
    }

    /* =====================================================
       TIMER
       ===================================================== */
    function startTimer() {
      var lvl = LEVELS[currentLevel];
      var totalTime = lvl.time;
      timeLeft = totalTime;
      updateTimerDisplay();

      timerInterval = setInterval(function() {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          endGame();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      var lvl = LEVELS[currentLevel];
      var pct = (timeLeft / lvl.time) * 100;
      var bar = document.getElementById('timerBar');
      bar.style.width = pct + '%';
      if (pct <= 20) {
        bar.className = 'timer-bar timer-danger';
      } else if (pct <= 50) {
        bar.className = 'timer-bar timer-warning';
      } else {
        bar.className = 'timer-bar';
      }
      document.getElementById('timerText').textContent = timeLeft + 's';
    }

    /* =====================================================
       NUMPAD INPUT
       ===================================================== */
    var numpadBtns = document.querySelectorAll('.numpad-btn');
    for (var i = 0; i < numpadBtns.length; i++) {
      numpadBtns[i].addEventListener('click', onNumpadTap);
      numpadBtns[i].addEventListener('touchend', onNumpadTap, { passive: false });
    }

    function onNumpadTap(e) {
      e.preventDefault();
      if (gameOver) return;
      var val = this.getAttribute('data-val');

      if (val === 'del') {
        userInput = userInput.slice(0, -1);
        document.getElementById('mathAnswer').textContent = userInput || '\u00a0';
      } else if (val === 'ok') {
        submitAnswer();
      } else {
        if (userInput.length < 6) {
          userInput += val;
          document.getElementById('mathAnswer').textContent = userInput;
        }
      }
    }

    /* =====================================================
       SUBMIT ANSWER
       ===================================================== */
    function submitAnswer() {
      if (userInput === '' || gameOver) return;

      var answer = parseInt(userInput, 10);
      var correct = questions[currentQ].answer;
      var feedback = document.getElementById('mathFeedback');

      if (answer === correct) {
        correctCount++;
        feedback.textContent = '\u2714 \u6b63\u786e\uff01';
        feedback.className = 'math-feedback feedback-correct';
        currentQ++;
        setTimeout(function() {
          showQuestion();
        }, 400);
      } else {
        feedback.textContent = '\u2718 \u7b54\u6848\u662f ' + correct;
        feedback.className = 'math-feedback feedback-wrong';
        currentQ++;
        setTimeout(function() {
          showQuestion();
        }, 1000);
      }
    }

    /* =====================================================
       END GAME
       ===================================================== */
    function endGame() {
      gameOver = true;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      var total = questions.length;
      var pct = correctCount / total;

      var stars = 0;
      if (pct >= 1) stars = 3;
      else if (pct >= 0.8) stars = 2;
      else if (pct >= 0.6) stars = 1;

      var passed = stars > 0;

      // Save progress
      if (passed) {
        var prog = loadProgress();
        var prev = prog.stars[currentLevel + 1] || 0;
        if (stars > prev) prog.stars[currentLevel + 1] = stars;
        if (currentLevel + 2 > prog.unlocked) {
          prog.unlocked = currentLevel + 2;
        }
        saveProgress(prog);
      }

      // Show overlay
      var starStr = '';
      for (var i = 0; i < 3; i++) {
        starStr += i < stars ? '\u2b50' : '\u2606';
      }

      document.getElementById('winTitle').textContent = passed ? '\u606d\u559c\u8fc7\u5173\uff01' : '\u672a\u80fd\u8fc7\u5173';
      document.getElementById('winStars').textContent = starStr;
      document.getElementById('winMsg').textContent = '\u7b54\u5bf9 ' + correctCount + ' / ' + total + ' \u9898' + (passed ? '' : '\uff08\u9700\u8981 60% \u6b63\u786e\u7387\uff09');

      var nextBtn = document.getElementById('winNextBtn');
      if (!passed || currentLevel + 1 >= LEVELS.length) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = '';
      }

      document.getElementById('winOverlay').className = 'overlay show';
    }

    /* =====================================================
       BUTTONS
       ===================================================== */
    document.getElementById('backBtn').addEventListener('click', function() {
      if (timerInterval) clearInterval(timerInterval);
      window.location.href = 'index.html';
    });

    document.getElementById('resetBtn').addEventListener('click', function() {
      if (timerInterval) clearInterval(timerInterval);
      if (currentLevel >= 0) startLevel(currentLevel);
    });

    document.getElementById('levelListBtn').addEventListener('click', function() {
      if (timerInterval) clearInterval(timerInterval);
      showLevelSelect();
    });

    document.getElementById('winBackBtn').addEventListener('click', function() {
      document.getElementById('winOverlay').className = 'overlay';
      showLevelSelect();
    });

    document.getElementById('winNextBtn').addEventListener('click', function() {
      document.getElementById('winOverlay').className = 'overlay';
      if (currentLevel + 1 < LEVELS.length) {
        startLevel(currentLevel + 1);
      }
    });

    function showLevelSelect() {
      document.getElementById('gameArea').className = 'game-area';
      document.getElementById('levelSelect').style.display = '';
      gameOver = true;
      renderLevelSelect();
    }

    /* =====================================================
       INIT
       ===================================================== */
    var initProg = loadProgress();
    if (initProg.unlocked < 1) {
      initProg.unlocked = 1;
      // Don't save progress during initialization - just ensure unlocked is set
      // saveProgress() expects currentLevel to be set, which it isn't during init
    }
    renderLevelSelect();

    // Register SW
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(function() {});
    }
  </script>
</body>
</html>
